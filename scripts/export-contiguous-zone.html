<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°å‡ºé„°æ¥å€ GeoJSON</title>
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.9.4/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.9.4/mapbox-gl.css" rel="stylesheet">
    <script src="https://unpkg.com/@turf/turf@7/turf.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
        }
        .container {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
        }
        button {
            background: #4264fb;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background: #3352d9;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        #status {
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 4px;
            min-height: 50px;
        }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        input {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            box-sizing: border-box;
        }
        label {
            display: block;
            margin: 10px 0 5px 0;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>é„°æ¥å€ GeoJSON è¨ˆç®—èˆ‡å°å‡ºå·¥å…·</h1>
        
        <label for="mapboxToken">Mapbox Access Token:</label>
        <input type="text" id="mapboxToken" placeholder="pk.eyJ1Ijo..." />
        
        <button onclick="initializeMap()">åˆå§‹åŒ–åœ°åœ–</button>
        <button onclick="calculateAndExport()" id="calcBtn" disabled>è¨ˆç®—ä¸¦å°å‡ºé„°æ¥å€</button>
        
        <div id="status"></div>
    </div>

    <div id="map" style="width: 100%; height: 400px; margin-top: 20px;"></div>

    <script>
        let map;
        let mapboxToken = '';
        
        function log(message, type = 'info') {
            const status = document.getElementById('status');
            status.className = type;
            status.innerHTML = message;
            console.log(message);
        }
        
        function initializeMap() {
            mapboxToken = document.getElementById('mapboxToken').value.trim();
            if (!mapboxToken) {
                log('è«‹è¼¸å…¥ Mapbox Token', 'error');
                return;
            }
            
            mapboxgl.accessToken = mapboxToken;
            
            map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/dark-v11',
                center: [121.0, 24.0],
                zoom: 7
            });
            
            map.on('load', () => {
                log('âœ… åœ°åœ–è¼‰å…¥æˆåŠŸ', 'success');
                document.getElementById('calcBtn').disabled = false;
                
                // æ·»åŠ åŸºç·šå’Œé ˜æµ·çš„ source
                setupSources();
            });
        }
        
        function setupSources() {
            const baselinesSourceId = 'source-ref-territorial-baselines';
            const territorialSeaSourceId = 'source-ref-territorial-sea';
            
            // æ·»åŠ åŸºç·š source
            if (!map.getSource(baselinesSourceId)) {
                map.addSource(baselinesSourceId, {
                    type: 'vector',
                    url: 'mapbox://cnagraphicdesign.bahwakzv'
                });
            }
            
            // æ·»åŠ é ˜æµ· source
            if (!map.getSource(territorialSeaSourceId)) {
                map.addSource(territorialSeaSourceId, {
                    type: 'vector',
                    url: 'mapbox://cnagraphicdesign.bahwakzv'
                });
            }
            
            // è¨­ç½®åœ°åœ–è¦–åœ–ä»¥ç¢ºä¿è¦†è“‹å°ç£å€åŸŸï¼ˆè§¸ç™¼ tile è¼‰å…¥ï¼‰
            map.fitBounds([
                [119.0, 21.5], // è¥¿å—è§’
                [122.5, 26.0]  // æ±åŒ—è§’
            ], {
                padding: 50,
                duration: 1000
            });
            
            // æ·»åŠ åŸºç·šåœ–å±¤ï¼ˆå¯è¦‹ï¼Œç”¨æ–¼è§¸ç™¼ tile è¼‰å…¥ï¼‰
            if (!map.getLayer('ref-territorial-baselines')) {
                map.addLayer({
                    id: 'ref-territorial-baselines',
                    type: 'line',
                    source: baselinesSourceId,
                    'source-layer': 'cartodb-query_1-90kmsi',
                    filter: ['==', ['get', 'name'], 'Taiwan Territorial Baselines (1999)'],
                    layout: { visibility: 'visible' },
                    paint: {
                        'line-color': '#ffffff',
                        'line-width': 1.5,
                        'line-opacity': 0.3
                    }
                });
            }
            
            // æ·»åŠ é ˜æµ·åœ–å±¤ï¼ˆå¯è¦‹ï¼Œç”¨æ–¼è§¸ç™¼ tile è¼‰å…¥ï¼‰
            if (!map.getLayer('ref-territorial-sea')) {
                map.addLayer({
                    id: 'ref-territorial-sea',
                    type: 'line',
                    source: territorialSeaSourceId,
                    'source-layer': 'cartodb-query_1-90kmsi',
                    filter: ['==', ['get', 'name'], 'Taiwan Territorial Sea'],
                    layout: { visibility: 'visible' },
                    paint: {
                        'line-color': '#ff4444',
                        'line-width': 1.2,
                        'line-opacity': 0.3
                    }
                });
            }
            
            log('ğŸ“– Source å’Œåœ–å±¤å·²è¨­ç½®ï¼Œåœ°åœ–æ­£åœ¨èª¿æ•´è¦–åœ–ä»¥è¼‰å…¥ tiles...', 'info');
        }
        
        async function calculateAndExport() {
            if (!map) {
                log('è«‹å…ˆåˆå§‹åŒ–åœ°åœ–', 'error');
                return;
            }
            
            log('ğŸ”„ é–‹å§‹è¨ˆç®—é„°æ¥å€...', 'info');
            
            try {
                // ç­‰å¾…åœ°åœ–è¼‰å…¥å®Œæˆ
                await new Promise(resolve => {
                    if (map.loaded()) {
                        resolve();
                    } else {
                        map.once('load', resolve);
                    }
                });
                
                // ç­‰å¾…åœ°åœ–è¦–åœ–èª¿æ•´å®Œæˆ
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // ç­‰å¾… source tiles è¼‰å…¥ - ä½¿ç”¨äº‹ä»¶ç›£è½
                log('â³ ç­‰å¾… tiles è¼‰å…¥ä¸­...', 'info');
                await new Promise(resolve => {
                    let tilesLoaded = 0;
                    const checkTiles = () => {
                        tilesLoaded++;
                        if (tilesLoaded >= 5) { // ç­‰å¾…è‡³å°‘ 5 å€‹ tile è¼‰å…¥äº‹ä»¶
                            resolve();
                        }
                    };
                    map.on('sourcedata', (e) => {
                        if (e.isSourceLoaded && 
                            (e.sourceId === 'source-ref-territorial-baselines' || 
                             e.sourceId === 'source-ref-territorial-sea')) {
                            checkTiles();
                        }
                    });
                    // è¶…æ™‚ä¿è­·
                    setTimeout(resolve, 10000);
                });
                
                // é¡å¤–ç­‰å¾…ç¢ºä¿ tiles å®Œå…¨è¼‰å…¥
                await new Promise(resolve => setTimeout(resolve, 3000));
                
                // æŸ¥è©¢åŸºç·šç‰¹å¾µ - å˜—è©¦å¤šæ¬¡ä»¥ç¢ºä¿è¼‰å…¥ tiles
                let baselineFeatures = map.querySourceFeatures('source-ref-territorial-baselines', {
                    sourceLayer: 'cartodb-query_1-90kmsi',
                    filter: ['==', ['get', 'name'], 'Taiwan Territorial Baselines (1999)']
                });
                
                log(`ğŸ“Š åˆæ¬¡æŸ¥è©¢ï¼šæ‰¾åˆ° ${baselineFeatures.length} å€‹åŸºç·šç‰¹å¾µ`, 'info');
                
                if (baselineFeatures.length === 0) {
                    log('âš ï¸ æœªæ‰¾åˆ°åŸºç·šæ•¸æ“šï¼Œå˜—è©¦èª¿æ•´åœ°åœ–è¦–åœ–å¾Œé‡è©¦...', 'error');
                    log('ğŸ’¡ æ­£åœ¨å˜—è©¦ç¸®æ”¾åœ°åœ–ä»¥è¼‰å…¥æ›´å¤š tiles...', 'info');
                    
                    // å˜—è©¦ä¸åŒçš„ç¸®æ”¾ç´šåˆ¥
                    map.zoomTo(8, { duration: 1000 });
                    await new Promise(resolve => setTimeout(resolve, 3000));
                    
                    baselineFeatures = map.querySourceFeatures('source-ref-territorial-baselines', {
                        sourceLayer: 'cartodb-query_1-90kmsi',
                        filter: ['==', ['get', 'name'], 'Taiwan Territorial Baselines (1999)']
                    });
                    
                    log(`ğŸ“Š ç¸®æ”¾ç´šåˆ¥ 8ï¼šæ‰¾åˆ° ${baselineFeatures.length} å€‹åŸºç·šç‰¹å¾µ`, 'info');
                    
                    if (baselineFeatures.length === 0) {
                        map.zoomTo(7, { duration: 1000 });
                        await new Promise(resolve => setTimeout(resolve, 3000));
                        
                        baselineFeatures = map.querySourceFeatures('source-ref-territorial-baselines', {
                            sourceLayer: 'cartodb-query_1-90kmsi',
                            filter: ['==', ['get', 'name'], 'Taiwan Territorial Baselines (1999)']
                        });
                        
                        log(`ğŸ“Š ç¸®æ”¾ç´šåˆ¥ 7ï¼šæ‰¾åˆ° ${baselineFeatures.length} å€‹åŸºç·šç‰¹å¾µ`, 'info');
                        
                        if (baselineFeatures.length === 0) {
                            log('âŒ å¤šæ¬¡å˜—è©¦å¾Œä»æœªæ‰¾åˆ°åŸºç·šæ•¸æ“šã€‚', 'error');
                            log('ğŸ’¡ è«‹æª¢æŸ¥ï¼š1) Token æ˜¯å¦æœ‰æ•ˆ 2) ç¶²çµ¡é€£æ¥ 3) åœ¨åœ°åœ–ä¸Šæ‰‹å‹•ç¸®æ”¾/å¹³ç§»å¾Œé‡è©¦', 'info');
                            log('ğŸ’¡ å»ºè­°ï¼šåœ¨åœ°åœ–ä¸Šæ”¾å¤§åˆ° level 8-9 ä¸¦å¹³ç§»ï¼Œç„¶å¾Œå†æ¬¡é»æ“Šã€Œè¨ˆç®—ä¸¦å°å‡ºé„°æ¥å€ã€', 'info');
                            return;
                        } else {
                            log(`âœ… åœ¨ç¸®æ”¾ç´šåˆ¥ 7 æ‰¾åˆ° ${baselineFeatures.length} å€‹åŸºç·šç‰¹å¾µï¼Œç¹¼çºŒè¨ˆç®—...`, 'success');
                        }
                    } else {
                        log(`âœ… åœ¨ç¸®æ”¾ç´šåˆ¥ 8 æ‰¾åˆ° ${baselineFeatures.length} å€‹åŸºç·šç‰¹å¾µï¼Œç¹¼çºŒè¨ˆç®—...`, 'success');
                    }
                } else {
                    log(`âœ… æ‰¾åˆ° ${baselineFeatures.length} å€‹åŸºç·šç‰¹å¾µï¼Œç¹¼çºŒè¨ˆç®—...`, 'success');
                }
                
                // æŸ¥è©¢é ˜æµ·ç‰¹å¾µ
                const territorialSeaFeatures = map.querySourceFeatures('source-ref-territorial-sea', {
                    sourceLayer: 'cartodb-query_1-90kmsi',
                    filter: ['==', ['get', 'name'], 'Taiwan Territorial Sea']
                });
                
                log(`ğŸ“Š æ‰¾åˆ° ${territorialSeaFeatures.length} å€‹é ˜æµ·ç‰¹å¾µï¼ˆå°‡ä½¿ç”¨å®Œæ•´ 24 æµ·é‡Œç·©è¡å€ï¼Œä¸æ¸›å»é ˜æµ·ï¼‰`, 'info');
                
                // è¨ˆç®— 24 æµ·é‡Œç·©è¡å€
                const buffered24nm = [];
                baselineFeatures.forEach(feature => {
                    if (feature.geometry.type === 'LineString' || feature.geometry.type === 'MultiLineString') {
                        const buffered = turf.buffer(
                            turf.feature(feature.geometry),
                            44.448, // 24 æµ·é‡Œ = 44.448 å…¬é‡Œ
                            { units: 'kilometers' }
                        );
                        if (buffered && (buffered.geometry.type === 'Polygon' || buffered.geometry.type === 'MultiPolygon')) {
                            buffered24nm.push(buffered);
                        }
                    }
                });
                
                if (buffered24nm.length === 0) {
                    log('âŒ ç·©è¡å€è¨ˆç®—å¤±æ•—', 'error');
                    return;
                }
                
                // åˆä½µæ‰€æœ‰ç·©è¡å€
                let contiguous24nm;
                if (buffered24nm.length === 1) {
                    contiguous24nm = buffered24nm[0];
                } else {
                    const fc = turf.featureCollection(buffered24nm);
                    const dissolved = turf.dissolve(fc);
                    contiguous24nm = dissolved.features[0];
                }
                
                // ä½¿ç”¨å®Œæ•´çš„ 24 æµ·é‡Œç·©è¡å€ï¼ˆåŒ…å«é ˜æµ·å’Œé™¸åœ°ï¼Œä¸æ¸›å»é ˜æµ·éƒ¨åˆ†ï¼‰
                let result = contiguous24nm;
                // æ³¨æ„ï¼šä¸å†æ¸›å»é ˜æµ·éƒ¨åˆ†ï¼Œç›´æ¥ä½¿ç”¨å®Œæ•´çš„ 24 æµ·é‡Œç·©è¡å€
                // é€™æ¨£å¯ä»¥é¡¯ç¤ºé„°æ¥å€çš„æœ€å¤§ç¯„åœï¼ˆåŒ…å«é ˜æµ·å’Œå¯èƒ½å»¶ä¼¸åˆ°çš„é™¸åœ°ï¼‰
                
                // å‰µå»º GeoJSON
                const geojson = turf.featureCollection([result]);
                geojson.features[0].properties = {
                    name: 'é„°æ¥å€ (Contiguous Zone)',
                    description: 'è‡ªé ˜æµ·åŸºç·šå‘å¤– 24 æµ·æµ¬ï¼ˆå®Œæ•´ç¯„åœï¼Œå«é ˜æµ·åŠé™¸åœ°ï¼‰'
                };
                
                // ä¸‹è¼‰æ–‡ä»¶
                const blob = new Blob([JSON.stringify(geojson, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'contiguous_zone.geojson';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                log('âœ… é„°æ¥å€ GeoJSON è¨ˆç®—å®Œæˆä¸¦å·²ä¸‹è¼‰ï¼', 'success');
                log(`ğŸ“¦ Feature é¡å‹: ${result.geometry.type}`, 'info');
                
            } catch (error) {
                log(`âŒ è¨ˆç®—å¤±æ•—: ${error.message}`, 'error');
                console.error(error);
            }
        }
        
        // å¾ localStorage æˆ– URL åƒæ•¸è®€å– token
        window.onload = () => {
            // å„ªå…ˆå¾ URL åƒæ•¸è®€å–
            const urlParams = new URLSearchParams(window.location.search);
            const urlToken = urlParams.get('token');
            
            // å…¶æ¬¡å¾ localStorage è®€å–
            const savedToken = localStorage.getItem('mapboxToken');
            
            const tokenInput = document.getElementById('mapboxToken');
            if (urlToken) {
                tokenInput.value = urlToken;
            } else if (savedToken) {
                tokenInput.value = savedToken;
            }
            
            tokenInput.addEventListener('change', (e) => {
                localStorage.setItem('mapboxToken', e.target.value);
            });
            
            // å¦‚æœæœ‰ tokenï¼Œè‡ªå‹•åˆå§‹åŒ–
            if (tokenInput.value) {
                setTimeout(() => {
                    initializeMap();
                }, 500);
            }
        };
    </script>
</body>
</html>

